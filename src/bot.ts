import 'dotenv/config';
import { Telegraf } from 'telegraf';
import { handleStart, handleHelp, getMainKeyboard, getCancelKeyboard } from './handlers/commands';
import { SupabaseService } from './services/supabase';
import { GoogleDriveService } from './services/googledrive';
import { getMoscowDateComponents, createMoscowDate, formatMoscowTime } from './utils/timezone';

const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const GOOGLE_FOLDER_ID = process.env.FOLDER_ID;

if (!BOT_TOKEN) {
  console.error('‚ùå TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!');
  console.error('–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –∏ –¥–æ–±–∞–≤—å—Ç–µ TELEGRAM_BOT_TOKEN=your_token_here');
  process.exit(1);
}

if (!BOT_TOKEN) {
  console.error('‚ùå TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
  process.exit(1);
}

if (!GOOGLE_FOLDER_ID) {
  console.error('‚ùå GOOGLE_FOLDER_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
  process.exit(1);
}

const bot = new Telegraf(BOT_TOKEN, {
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤ 30 –º–∏–Ω—É—Ç (–∑–∞–ø–∞—Å, —Ö–æ—Ç—è –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Å—Ç—ã–µ)
  handlerTimeout: 1800000,
});

const supabaseService = new SupabaseService();
const googleDriveService = new GoogleDriveService(GOOGLE_FOLDER_ID);

// –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É —á–∞—Ç–∞
const userState = new Map<number, 'awaiting_schedule'>();

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –±–ª–∏–∂–∞–π—à–µ–≥–æ —Å–ª–æ—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –º–∞—Å—Å–∏–≤–∞ —Å–ª–æ—Ç–æ–≤
// –í—Å–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
function calculateNextPublishAt(lastPublishAtIso: string | null, slots: number[]): Date {
  // –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –º–∞—Å—Å–∏–≤ —Å–ª–æ—Ç–æ–≤: –µ—Å–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  const effectiveSlots = slots.length > 0 ? [...slots].sort((a, b) => a - b) : [10, 15, 18];
  // –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
  const nowMoscow = getMoscowDateComponents(new Date());

  // –û–±—ä—è–≤–ª—è–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–ª–∏–∂–∞–π—à–µ–≥–æ —Å–ª–æ—Ç–∞, –Ω–∞—á–∏–Ω–∞—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞
  const findNextSlotFromNow = (): Date => {
    // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å–ª–æ—Ç–∞–º —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω–∏
    for (const slotHour of effectiveSlots) {
      // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–ª–æ—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω–∏
      const candidate = createMoscowDate(
        nowMoscow.year,
        nowMoscow.month,
        nowMoscow.day,
        slotHour,
        0,
        0
      );
      // –ï—Å–ª–∏ —Å–ª–æ—Ç –µ—â–µ –≤–ø–µ—Ä–µ–¥–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —Å—Ä–∞–∑—É –µ–≥–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
      if (candidate > new Date()) {
        return candidate;
      }
    }
    // –ï—Å–ª–∏ –≤—Å–µ —Å–ª–æ—Ç—ã —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è —É–∂–µ –ø—Ä–æ—à–ª–∏, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
    // –í—ã—á–∏—Å–ª—è–µ–º –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω–∏
    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∞—Ç—É –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
    const todayMoscow = createMoscowDate(nowMoscow.year, nowMoscow.month, nowMoscow.day, 0, 0, 0);
    const nextDayTemp = new Date(todayMoscow.getTime() + 24 * 60 * 60 * 1000);
    const nextDayMoscow = getMoscowDateComponents(nextDayTemp);
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —Å–ª–æ—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è –∫–∞–∫ –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏—Ç–æ–≥–æ–≤–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ —Å–ª–æ—Ç–æ–≤
    return createMoscowDate(
      nextDayMoscow.year,
      nextDayMoscow.month,
      nextDayMoscow.day,
      effectiveSlots[0],
      0,
      0
    );
  };

  // –ï—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –¥–∞—Ç—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–µ—Ç –≤–æ–≤—Å–µ, –∏—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π —Å–ª–æ—Ç –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞
  if (!lastPublishAtIso) {
    // –í—ã–∑—ã–≤–∞–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π –±–ª–∏–∂–∞–π—à–∏–π —Å–ª–æ—Ç
    return findNextSlotFromNow();
  }

  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º ISO-—Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –æ–±—ä–µ–∫—Ç Date
  const lastDate = new Date(lastPublishAtIso);
  // –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω–∏
  const lastMoscow = getMoscowDateComponents(lastDate);
  // –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—è—è –¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —É–∂–µ –≤ –ø—Ä–æ—à–ª–æ–º –∏–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º –º–æ–º–µ–Ω—Ç–æ–º
  if (lastDate <= new Date()) {
    // –í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –æ—á–µ—Ä–µ–¥—å —Å—á–∏—Ç–∞–µ–º –ø—É—Å—Ç–æ–π –∏ –∏—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    return findNextSlotFromNow();
  }

  // –ü–æ–ª—É—á–∞–µ–º —á–∞—Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞ —Å–ª–æ—Ç–∞
  const lastHour = lastMoscow.hour;
  // –ò—â–µ–º –∏–Ω–¥–µ–∫—Å —Å–ª–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —á–∞—Å—É –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
  const currentSlotIndex = effectiveSlots.indexOf(lastHour);

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–ª–æ—Ç –Ω–∞–π–¥–µ–Ω –∏ –æ–Ω –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º –≤ –º–∞—Å—Å–∏–≤–µ —Å–ª–æ—Ç–æ–≤
  if (currentSlotIndex !== -1 && currentSlotIndex < effectiveSlots.length - 1) {
    // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ª–æ—Ç–∞ —Ç–æ–≥–æ –∂–µ –¥–Ω—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω–∏
    const sameDayNextSlot = createMoscowDate(
      lastMoscow.year,
      lastMoscow.month,
      lastMoscow.day,
      effectiveSlots[currentSlotIndex + 1],
      0,
      0
    );
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω—É—é –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ª–æ—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
    return sameDayNextSlot;
  }

  // –ï—Å–ª–∏ —á–∞—Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ —Å–ø–∏—Å–æ–∫ —Å–ª–æ—Ç–æ–≤
  // –∏–ª–∏ —ç—Ç–æ –±—ã–ª –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–ª–æ—Ç –¥–Ω—è, –ø–ª–∞–Ω–∏—Ä—É–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏—é –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
  // –í—ã—á–∏—Å–ª—è–µ–º –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω–∏
  const lastDayMoscow = createMoscowDate(lastMoscow.year, lastMoscow.month, lastMoscow.day, 0, 0, 0);
  const nextDayTemp = new Date(lastDayMoscow.getTime() + 24 * 60 * 60 * 1000);
  const nextDayMoscow = getMoscowDateComponents(nextDayTemp);
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –ø–µ—Ä–≤—ã–π —Å–ª–æ—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è –∫–∞–∫ –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏—Ç–æ–≥–æ–≤–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ —Å–ª–æ—Ç–æ–≤
  const nextDayFirstSlot = createMoscowDate(
    nextDayMoscow.year,
    nextDayMoscow.month,
    nextDayMoscow.day,
    effectiveSlots[0],
    0,
    0
  );
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞—Ç—É –ø–µ—Ä–≤–æ–≥–æ —Å–ª–æ—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
  return nextDayFirstSlot;
}

// –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase
async function initialize() {
  await googleDriveService.init();
  console.log('‚úÖ Google Drive –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');

  const isConnected = await supabaseService.checkConnection();
  if (isConnected) {
    console.log('‚úÖ Supabase –ø–æ–¥–∫–ª—é—á—ë–Ω');
  } else {
    console.warn('‚ö†Ô∏è Supabase –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç');
  }
}

// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.command('start', handleStart);
// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
bot.command('help', handleHelp);

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π - –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Ö –≤ Google Drive –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ç—å—é –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥–ø–∏—Å—å)
bot.on('photo', async (ctx) => {
  try {
    const articleText = ctx.message.caption || '';
    const hasText = articleText.trim().length > 0;

    const processingMessage = await ctx.reply(
      hasText
        ? 'üì• –ó–∞–≥—Ä—É–∂–∞—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è—é —Å—Ç–∞—Ç—å—é...'
        : 'üì• –ó–∞–≥—Ä—É–∂–∞—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...',
      getMainKeyboard()
    );

    const largestPhoto = ctx.message.photo.at(-1);
    if (!largestPhoto) throw new Error('–§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');

    const fileInfo = await ctx.telegram.getFile(largestPhoto.file_id);
    if (!fileInfo.file_path) throw new Error('file_path –ø—É—Å—Ç–æ–π');

    const fileUrl = `https://api.telegram.org/file/bot${BOT_TOKEN}/${fileInfo.file_path}`;
    const response = await fetch(fileUrl);
    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞');

    const buffer = Buffer.from(await response.arrayBuffer());

    const ext = fileInfo.file_path.split('.').pop() || 'jpg';
    const mimeType = ext === 'png' ? 'image/png' : 'image/jpeg';
    const fileName = `telegram_${formatMoscowTime(new Date()).replace(
      /[.:\s]/g,
      '_'
    )}.${ext}`;

    const driveLink = await googleDriveService.uploadFile(
      fileName,
      buffer,
      mimeType
    );

    if (hasText) {
      const lastPost = await supabaseService.getLastPost();
      const slots = await supabaseService.getScheduleHours();
      const publishAt = calculateNextPublishAt(
        lastPost?.publish_at || null,
        slots
      );

      const post = await supabaseService.insertPost(
        articleText,
        publishAt,
        driveLink
      );

      await ctx.reply(
        `‚úÖ –°—Ç–∞—Ç—å—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞\n\nüìÖ ${formatMoscowTime(
          new Date(post.publish_at)
        )}`,
        getMainKeyboard()
      );
    } else {
      await ctx.telegram.editMessageText(
        ctx.chat.id,
        processingMessage.message_id,
        undefined,
        `‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ\n\nüìé ${driveLink}`
      );
    }
  } catch (error: any) {
    console.error(error);
    await ctx.reply(
      `‚ùå –û—à–∏–±–∫–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`,
      getMainKeyboard()
    );
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–π –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –ø–æ—Å—Ç—ã
bot.on('text', async (ctx) => {
  // –ï—Å–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –æ–Ω–æ –Ω–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ, –≤—ã—Ö–æ–¥–∏–º
  if (!ctx.message || !('text' in ctx.message)) {
    return;
  }

  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const text = ctx.message.text;
  // –ü–æ–ª—É—á–∞–µ–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —á–∞—Ç–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
  const chatId = ctx.chat?.id;

  // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–Ω–æ–ø–∫–∏ - –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –≤ —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "–û—Ç–º–µ–Ω–∏—Ç—å", –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ –≤–≤–æ–¥–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
  if (text === '–û—Ç–º–µ–Ω–∏—Ç—å') {
    if (chatId !== undefined && userState.get(chatId) === 'awaiting_schedule') {
      // –£–¥–∞–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      userState.delete(chatId);
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ
      await ctx.reply('‚ùå –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–æ.', getMainKeyboard());
      return;
    }
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è, –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
    return;
  }

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π
  if (text === '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ') {
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –≤ —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è, –≤—ã—Ö–æ–¥–∏–º –∏–∑ –Ω–µ–≥–æ
    if (chatId !== undefined && userState.get(chatId) === 'awaiting_schedule') {
      userState.delete(chatId);
    }

    try {
      // –ü–æ–ª—É—á–∞–µ–º –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ –ø–æ—Å—Ç—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º scheduled, –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞ —Ç–µ–∫—É—â–µ–µ –∏ –±—É–¥—É—â–µ–µ –≤—Ä–µ–º—è
      const scheduledPosts = await supabaseService.getScheduledPosts();

      // –ï—Å–ª–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –Ω–µ—Ç, –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      if (scheduledPosts.length === 0) {
        await ctx.reply('üì≠ –°–µ–π—á–∞—Å –Ω–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π.', getMainKeyboard());
      } else {
        // –§–æ—Ä–º–∏—Ä—É–µ–º —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π —Å–ø–∏—Å–æ–∫ –¥–∞—Ç –∏ –≤—Ä–µ–º–µ–Ω–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–π
        const lines = scheduledPosts.map((post, index) => {
          // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º ISO-–¥–∞—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –æ–±—ä–µ–∫—Ç Date
          const publishDate = new Date(post.publish_at);
          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω–∏
          const formatted = formatMoscowTime(publishDate);
          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å –ø–æ—Ä—è–¥–∫–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º –∏ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–∞—Ç–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
          return `${index + 1}. ${formatted}`;
        });

        // –°–æ–±–∏—Ä–∞–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–æ–º –¥–∞—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π
        const message = 'üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π:\n\n' + lines.join('\n');
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
        await ctx.reply(message, getMainKeyboard());
      }
    } catch (error: any) {
      // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø–æ—Å—Ç–æ–≤:', error);
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π
      await ctx.reply('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', getMainKeyboard());
    }

    // –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∏–º –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
    return;
  }

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ß–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã"
if (text === '–ß–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã') {
  try {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Google Drive, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    if (!googleDriveService.isInitialized()) {
      await googleDriveService.init();
    }
    
    // –£–¥–∞–ª—è–µ–º –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    const deletedCount = await supabaseService.deletePublishedPosts(googleDriveService);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
    await ctx.reply(`‚úÖ –£–¥–∞–ª–µ–Ω–æ ${deletedCount} –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –∏ –∏—Ö —Ñ–∞–π–ª–æ–≤.`);
  } catch (error: any) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Ç–∞–±–ª–∏—Ü—ã:', error);
    await ctx.reply(`‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Ç–∞–±–ª–∏—Ü—ã: ${error.message}`);
  }
  return;
}

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ —á–∞—Å—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–π
  if (text === '–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ') {
    // –ï—Å–ª–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —á–∞—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥ –∏ –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º
    if (chatId === undefined) {
      return;
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞ —á–∞—Å–æ–≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    userState.set(chatId, 'awaiting_schedule');
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ —Ñ–æ—Ä–º–∞—Ç—É –≤–≤–æ–¥–∞ —á–∞—Å–æ–≤ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π —Å –∫–Ω–æ–ø–∫–æ–π –æ—Ç–º–µ–Ω—ã
    await ctx.reply('üïí –û—Ç–ø—Ä–∞–≤—å—Ç–µ —á–∞—Å—ã —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª, –≤ –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—å–∏. –ü—Ä–∏–º–µ—Ä: "9 13 20".\n\n–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–û—Ç–º–µ–Ω–∏—Ç—å", —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥.', getCancelKeyboard());

    // –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤—ã—Ö–æ–¥–∏–º –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
    return;
  }

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ –≤–≤–æ–¥–∞ –Ω–æ–≤–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–≤–æ–¥ —á–∞—Å–æ–≤
  if (chatId !== undefined && userState.get(chatId) === 'awaiting_schedule') {
    try {
      // –†–∞–∑–±–∏–≤–∞–µ–º –≤–≤–µ–¥–µ–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É –Ω–∞ —á–∞—Å—Ç–∏ –ø–æ –ø—Ä–æ–±–µ–ª–∞–º
      const parts = text.trim().split(/\s+/);
      // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∞–ª–∏–¥–Ω—ã—Ö —á–∏—Å–µ–ª-—á–∞—Å–æ–≤
      const hours: number[] = [];

      // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —á–∞—Å—Ç—è–º, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å —á–∞—Å—ã
      for (const part of parts) {
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é —á–∞—Å—Ç—å –≤ —á–∏—Å–ª–æ
        const value = Number(part);
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –æ—Ç 0 –¥–æ 23
        if (!Number.isInteger(value) || value < 0 || value > 23) {
          // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π —Ñ–æ—Ä–º–∞—Ç–∞
          await ctx.reply('‚ùå –ß–∞—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ü–µ–ª—ã–º–∏ —á–∏—Å–ª–∞–º–∏ –æ—Ç 0 –¥–æ 23. –ü—Ä–∏–º–µ—Ä: "9 13 20". –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\n\n–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–û—Ç–º–µ–Ω–∏—Ç—å", —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥.', getCancelKeyboard());
          // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É, –Ω–µ –º–µ–Ω—è—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
          return;
        }
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —á–∞—Å–∞ –≤ –º–∞—Å—Å–∏–≤
        hours.push(value);
      }

      // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã —á–∞—Å–æ–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –∏—Ö –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é
      const uniqueSortedHours = Array.from(new Set(hours)).sort((a, b) => a - b);

      // –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–∞—Å—Å–∏–≤ –æ–∫–∞–∑–∞–ª—Å—è –ø—É—Å—Ç—ã–º, —Å–æ–æ–±—â–∞–µ–º –æ–± –æ—à–∏–±–∫–µ –≤–≤–æ–¥–∞
      if (uniqueSortedHours.length === 0) {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–¥—Å–∫–∞–∑–∫—É –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É–∫–∞–∑–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —á–∞—Å
        await ctx.reply('‚ùå –ù—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —á–∞—Å. –ü—Ä–∏–º–µ—Ä: "9 13 20".\n\n–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–û—Ç–º–µ–Ω–∏—Ç—å", —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥.', getCancelKeyboard());
        // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        return;
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–µ —á–∞—Å—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤ Supabase —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å
      await supabaseService.replaceScheduleHours(uniqueSortedHours);

      // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö —á–∞—Å–æ–≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
      const hoursList = uniqueSortedHours.map((h) => `${h.toString().padStart(2, '0')}:00`).join(', ');
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º
      await ctx.reply(`‚úÖ –ù–æ–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${hoursList}`, getMainKeyboard());

      // –£–¥–∞–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      userState.delete(chatId);
    } catch (error: any) {
      // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π:', error);
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π
      await ctx.reply('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', getCancelKeyboard());
    }

    // –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–≤–æ–¥–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤—ã—Ö–æ–¥–∏–º –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
    return;
  }


  // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Å–∏–º–≤–æ–ª–∞ /, —Å—á–∏—Ç–∞–µ–º –µ–≥–æ –∫–æ–º–∞–Ω–¥–æ–π –∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∑–¥–µ—Å—å
  if (text.startsWith('/')) {
    return;
  }

  try {
    // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ—Å—Ç –∏–∑ Supabase
    const lastPost = await supabaseService.getLastPost();
    // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —á–∞—Å–æ–≤ –ø—É–±–ª–∏–∫–∞—Ü–∏–π –∏–∑ Supabase
    const scheduleHours = await supabaseService.getScheduleHours();
    // –í—ã—á–∏—Å–ª—è–µ–º —Å–ª–µ–¥—É—é—â—É—é –¥–∞—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å—Ç–∞
    const nextPublishAt = calculateNextPublishAt(lastPost ? lastPost.publish_at : null, scheduleHours);

    // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –ø–æ—Å—Ç –≤ —Ç–∞–±–ª–∏—Ü—É post —Å —Ç–µ–∫—Å—Ç–æ–º –∏ –≤—Ä–µ–º–µ–Ω–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
    const createdPost = await supabaseService.insertPost(text, nextPublishAt);

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –æ–±—ä–µ–∫—Ç Date –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const publishDate = new Date(createdPost.publish_at);

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞ DD.MM.YYYY HH:MM –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω–∏
    const formattedDate = formatMoscowTime(publishDate);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
    await ctx.reply(`‚úÖ –ü–æ—Å—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ ${formattedDate}.`);
  } catch (error: any) {
    // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç–∞
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ—Å—Ç–∞:', error);
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π
    await ctx.reply('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –ø–æ–∑–∂–µ.');
  }
});

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –±–æ—Ç–∞
bot.catch((err, ctx) => {
  // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –±–æ—Ç–∞ –≤–º–µ—Å—Ç–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
  console.error('–û—à–∏–±–∫–∞ –≤ –±–æ—Ç–µ:', err);
  // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
  ctx.reply('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
});

// –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
initialize()
  .then(() => bot.launch())
  .then(() => console.log('ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω'))
  .catch((e) => {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞', e);
    process.exit(1);
  });

// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª SIGINT –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞
process.once('SIGINT', () => bot.stop('SIGINT'));
// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª SIGTERM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞
process.once('SIGTERM', () => bot.stop('SIGTERM'));
