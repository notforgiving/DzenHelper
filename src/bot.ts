import 'dotenv/config';
import { Telegraf } from 'telegraf';
import { handleStart, handleHelp } from './handlers/commands';
import { SupabaseService } from './services/supabase';

const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;

if (!BOT_TOKEN) {
  console.error('‚ùå TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!');
  console.error('–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –∏ –¥–æ–±–∞–≤—å—Ç–µ TELEGRAM_BOT_TOKEN=your_token_here');
  process.exit(1);
}

const bot = new Telegraf(BOT_TOKEN, {
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤ 30 –º–∏–Ω—É—Ç (–∑–∞–ø–∞—Å, —Ö–æ—Ç—è –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Å—Ç—ã–µ)
  handlerTimeout: 1800000,
});

// –°–æ–∑–¥–∞–µ–º –æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞ Supabase –¥–ª—è –≤—Å–µ–≥–æ –±–æ—Ç–∞
const supabaseService = new SupabaseService();

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –±–ª–∏–∂–∞–π—à–µ–≥–æ —Å–ª–æ—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
function calculateNextPublishAt(lastPublishAtIso: string | null): Date {
  // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —á—Ç–æ–±—ã —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å —Å–ª–æ—Ç–∞–º–∏
  const now = new Date();
  // –û–ø–∏—Å—ã–≤–∞–µ–º –º–∞—Å—Å–∏–≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ —á–∞—Å–∞—Ö (—Ç—Ä–∏ —Å–ª–æ—Ç–∞: 10:00, 15:00 –∏ 18:00)
  const slots = [10, 15, 18];

  // –û–±—ä—è–≤–ª—è–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–ª–∏–∂–∞–π—à–µ–≥–æ —Å–ª–æ—Ç–∞, –Ω–∞—á–∏–Ω–∞—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞
  const findNextSlotFromNow = (): Date => {
    // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    const todayBase = new Date(now);
    // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å–ª–æ—Ç–∞–º —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
    for (const slotHour of slots) {
      // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–ª–æ—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
      const candidate = new Date(todayBase);
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–∞—Å —Å–ª–æ—Ç–∞ –∏ –æ–±–Ω—É–ª—è–µ–º –º–∏–Ω—É—Ç—ã, —Å–µ–∫—É–Ω–¥—ã –∏ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
      candidate.setHours(slotHour, 0, 0, 0);
      // –ï—Å–ª–∏ —Å–ª–æ—Ç –µ—â–µ –≤–ø–µ—Ä–µ–¥–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —Å—Ä–∞–∑—É –µ–≥–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
      if (candidate > now) {
        return candidate;
      }
    }
    // –ï—Å–ª–∏ –≤—Å–µ —Å–ª–æ—Ç—ã —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è —É–∂–µ –ø—Ä–æ—à–ª–∏, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
    const nextDay = new Date(now);
    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–µ–Ω—å –Ω–∞ –µ–¥–∏–Ω–∏—Ü—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
    nextDay.setDate(nextDay.getDate() + 1);
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —Å–ª–æ—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è (10:00)
    nextDay.setHours(slots[0], 0, 0, 0);
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω—É—é –¥–∞—Ç—É –ø–µ—Ä–≤–æ–≥–æ —Å–ª–æ—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
    return nextDay;
  };

  // –ï—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –¥–∞—Ç—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–µ—Ç –≤–æ–≤—Å–µ, –∏—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π —Å–ª–æ—Ç –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞
  if (!lastPublishAtIso) {
    // –í—ã–∑—ã–≤–∞–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π –±–ª–∏–∂–∞–π—à–∏–π —Å–ª–æ—Ç
    return findNextSlotFromNow();
  }

  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º ISO-—Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –æ–±—ä–µ–∫—Ç Date
  const lastDate = new Date(lastPublishAtIso);
  // –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—è—è –¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —É–∂–µ –≤ –ø—Ä–æ—à–ª–æ–º –∏–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º –º–æ–º–µ–Ω—Ç–æ–º
  if (lastDate <= now) {
    // –í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –æ—á–µ—Ä–µ–¥—å —Å—á–∏—Ç–∞–µ–º –ø—É—Å—Ç–æ–π –∏ –∏—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    return findNextSlotFromNow();
  }

  // –ü–æ–ª—É—á–∞–µ–º —á–∞—Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞ —Å–ª–æ—Ç–∞
  const lastHour = lastDate.getHours();
  // –ò—â–µ–º –∏–Ω–¥–µ–∫—Å —Å–ª–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —á–∞—Å—É –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
  const currentSlotIndex = slots.indexOf(lastHour);

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–ª–æ—Ç –Ω–∞–π–¥–µ–Ω –∏ –æ–Ω –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º –≤ –º–∞—Å—Å–∏–≤–µ —Å–ª–æ—Ç–æ–≤
  if (currentSlotIndex !== -1 && currentSlotIndex < slots.length - 1) {
    // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é –¥–∞—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ª–æ—Ç–∞
    const sameDayNextSlot = new Date(lastDate);
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Å–ª–æ—Ç —Ç–æ–≥–æ –∂–µ –¥–Ω—è
    sameDayNextSlot.setHours(slots[currentSlotIndex + 1], 0, 0, 0);
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω—É—é –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ª–æ—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
    return sameDayNextSlot;
  }

  // –ï—Å–ª–∏ —á–∞—Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ —Å–ø–∏—Å–æ–∫ —Å–ª–æ—Ç–æ–≤
  // –∏–ª–∏ —ç—Ç–æ –±—ã–ª –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–ª–æ—Ç –¥–Ω—è, –ø–ª–∞–Ω–∏—Ä—É–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏—é –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
  const nextDayFirstSlot = new Date(lastDate);
  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–∞—Ç—É –Ω–∞ –æ–¥–∏–Ω –¥–µ–Ω—å, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–Ω—é
  nextDayFirstSlot.setDate(nextDayFirstSlot.getDate() + 1);
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –ø–µ—Ä–≤—ã–π —Å–ª–æ—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è (10:00)
  nextDayFirstSlot.setHours(slots[0], 0, 0, 0);
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞—Ç—É –ø–µ—Ä–≤–æ–≥–æ —Å–ª–æ—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
  return nextDayFirstSlot;
}

// –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase
async function initialize() {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å
    const isConnected = await supabaseService.checkConnection();
    // –ï—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ, –≤—ã–≤–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if (isConnected) {
      console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    } else {
      // –ï—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å, –≤—ã–≤–æ–¥–∏–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –≤–æ–∑–º–æ–∂–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–µ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
      console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Supabase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è SUPABASE_URL –∏ SUPABASE_ANON_KEY');
    }
  } catch (error) {
    // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase
    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase:', error);
  }
}

// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.command('start', handleStart);
// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
bot.command('help', handleHelp);

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–π –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –ø–æ—Å—Ç—ã
bot.on('text', async (ctx) => {
  // –ï—Å–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –æ–Ω–æ –Ω–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ, –≤—ã—Ö–æ–¥–∏–º
  if (!ctx.message || !('text' in ctx.message)) {
    return;
  }

  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const text = ctx.message.text;

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç, –∑–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤
  if (text === 'üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞—Ç—ã') {
    try {
      // –í—ã–∑—ã–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –ø—Ä–æ—à–µ–¥—à–∏—Ö –ø–æ—Å—Ç–æ–≤ –∫–∞–∫ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö
      const updatedCount = await supabaseService.markPastPostsAsPublished();

      // –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –Ω–µ—Ç, –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      if (updatedCount === 0) {
        await ctx.reply('‚úÖ –ù–µ—Ç –ø–æ—Å—Ç–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –í—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –µ—â—ë –≤ –±—É–¥—É—â–µ–º.');
      } else {
        // –ò–Ω–∞—á–µ —Å–æ–æ–±—â–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –ø–æ—Å—Ç–æ–≤ –±—ã–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ
        await ctx.reply(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ—Å—Ç–æ–≤: ${updatedCount}. –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ "–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ" –¥–ª—è –ø—Ä–æ—à–µ–¥—à–∏—Ö –¥–∞—Ç.`);
      }
    } catch (error: any) {
      // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ—Å—Ç–æ–≤:', error);
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π
      await ctx.reply('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞—Ç—ã –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }

    // –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∏–º –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
    return;
  }

  // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Å–∏–º–≤–æ–ª–∞ /, —Å—á–∏—Ç–∞–µ–º –µ–≥–æ –∫–æ–º–∞–Ω–¥–æ–π –∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∑–¥–µ—Å—å
  if (text.startsWith('/')) {
    return;
  }

  try {
    // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ—Å—Ç –∏–∑ Supabase
    const lastPost = await supabaseService.getLastPost();

    // –í—ã—á–∏—Å–ª—è–µ–º —Å–ª–µ–¥—É—é—â—É—é –¥–∞—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å—Ç–∞
    const nextPublishAt = calculateNextPublishAt(lastPost ? lastPost.publish_at : null);

    // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –ø–æ—Å—Ç –≤ —Ç–∞–±–ª–∏—Ü—É post —Å —Ç–µ–∫—Å—Ç–æ–º –∏ –≤—Ä–µ–º–µ–Ω–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
    const createdPost = await supabaseService.insertPost(text, nextPublishAt);

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –æ–±—ä–µ–∫—Ç Date –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const publishDate = new Date(createdPost.publish_at);

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞ DD.MM.YYYY HH:MM –ø–æ –ª–æ–∫–∞–ª–∏ ru-RU
    const formattedDate = publishDate.toLocaleString('ru-RU', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
    await ctx.reply(`‚úÖ –ü–æ—Å—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ ${formattedDate} (—Å—Ç–∞—Ç—É—Å: ${createdPost.status}).`);
  } catch (error: any) {
    // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç–∞
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ—Å—Ç–∞:', error);
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π
    await ctx.reply('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –ø–æ–∑–∂–µ.');
  }
});

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –±–æ—Ç–∞
bot.catch((err, ctx) => {
  // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –±–æ—Ç–∞ –≤–º–µ—Å—Ç–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
  console.error('–û—à–∏–±–∫–∞ –≤ –±–æ—Ç–µ:', err);
  // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
  ctx.reply('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
});

// –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
async function start() {
  // –í—ã–ø–æ–ª–Ω—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é (–ø—Ä–æ–≤–µ—Ä–∫—É Supabase)
  await initialize();

  // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
  console.log('üöÄ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞...');
  // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Supabase
  console.log('üìã –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Supabase –Ω–∞—Å—Ç—Ä–æ–µ–Ω (SUPABASE_URL –∏ SUPABASE_ANON_KEY –≤ .env)');

  // –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—É—Å–∫–∞
  bot.launch().then(() => {
    // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
    console.log('‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!');
  }).catch((error) => {
    // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞:', error);
    // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Å –∫–æ–¥–æ–º –æ—à–∏–±–∫–∏
    process.exit(1);
  });
}

// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª SIGINT –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞
process.once('SIGINT', () => bot.stop('SIGINT'));
// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª SIGTERM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞
process.once('SIGTERM', () => bot.stop('SIGTERM'));

// –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å —Å—Ç–∞—Ä—Ç–∞ –±–æ—Ç–∞
start();